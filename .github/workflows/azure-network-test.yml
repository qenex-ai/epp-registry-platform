name: Azure Network Connection Test

on:
  workflow_dispatch:
    inputs:
      test_endpoint:
        description: 'Private endpoint to test (optional)'
        required: false
        default: 'none'

jobs:
  test-network-connection:
    name: Test Azure VNet Connection
    runs-on: ubuntu-latest

    # Use Azure Virtual Network configuration
    network:
      configuration: qenex-github-actions-network

    steps:
      - name: Check runner IP address
        run: |
          echo "ğŸŒ Checking runner public IP address..."
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV

      - name: Test Azure Management API
        run: |
          echo "ğŸ” Testing connection to Azure Management API..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://management.azure.com)
          echo "Response code: $HTTP_CODE"
          if [ "$HTTP_CODE" -eq 401 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Successfully reached Azure Management API"
          else
            echo "âš ï¸ Unexpected response code: $HTTP_CODE"
          fi

      - name: Test GitHub API connectivity
        run: |
          echo "ğŸ” Testing connection to GitHub API..."
          curl -s https://api.github.com | head -5
          echo "âœ… GitHub API accessible"

      - name: Test DNS resolution
        run: |
          echo "ğŸ” Testing DNS resolution..."
          nslookup github.com
          nslookup management.azure.com
          echo "âœ… DNS working correctly"

      - name: Network diagnostics
        run: |
          echo "ğŸ“Š Network Diagnostics:"
          echo "-------------------"
          echo "Hostname: $(hostname)"
          echo "Network interfaces:"
          ip addr show | grep -E "inet |link"
          echo ""
          echo "Default routes:"
          ip route show

      - name: Test custom endpoint
        if: inputs.test_endpoint != 'none'
        run: |
          echo "ğŸ” Testing custom endpoint: ${{ inputs.test_endpoint }}"
          curl -v -m 10 ${{ inputs.test_endpoint }} || echo "âš ï¸ Could not reach endpoint"

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Azure Network Connection Test Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner IP: $RUNNER_IP"
          echo "Network Config: qenex-github-actions-network"
          echo "VNet: germany-vnet"
          echo "Subnet: github-actions-subnet"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
